name: Release Binary

on:
  workflow_dispatch:
  pull_request:
  push:
    paths-ignore:
      - '.github/**'
    branches:
      - main
    tags:
      - "*"

permissions:
  id-token: write
  attestations: write
  contents: write

jobs:
  release:
    name: Release - ${{ matrix.platform.os-name }}
    strategy:
      matrix:
        platform:
          - os-name: Linux x86_64
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive-name: gilt-linux-x86_64

          - os-name: Linux aarch64
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            archive-name: gilt-linux-aarch64

          - os-name: macOS x86_64
            runs-on: macos-13
            target: x86_64-apple-darwin
            archive-name: gilt-macos-x86_64

          - os-name: macOS aarch64
            runs-on: macOS-latest
            target: aarch64-apple-darwin
            archive-name: gilt-macos-aarch64

          - os-name: Windows x86_64
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
            archive-name: gilt-windows-x86_64

          - os-name: Windows aarch64
            runs-on: windows-11-arm
            target: aarch64-pc-windows-msvc
            archive-name: gilt-windows-aarch64


    runs-on: ${{ matrix.platform.runs-on }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - if: matrix.platform.runs-on == 'windows-11-arm'
        name: Preinstall rustup for Windows ARM (https://github.com/actions/partner-runner-images/issues/77)
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://static.rust-lang.org/rustup/dist/aarch64-pc-windows-msvc/rustup-init.exe" -OutFile rustup-init.exe
          .\rustup-init.exe --default-toolchain none -y
          "$env:USERPROFILE\.cargo\bin" | Out-File -Append -Encoding ascii $env:GITHUB_PATH
          "CARGO_HOME=$env:USERPROFILE\.cargo" | Out-File -Append -Encoding ascii $env:GITHUB_ENV

      - name: Build binary
        uses: houseabsolute/actions-rust-cross@f7da4010930154943c99d13df0151dece91a924f # v1.0.4
        with:
          command: build
          target: ${{ matrix.platform.target }}
          args: "--locked --release"
          strip: true
          rust-cache-parameters: "{\"save-if\": ${{ github.ref == 'refs/heads/main' }}}"

      - name: Publish artifacts and release
        uses: houseabsolute/actions-rust-release@48ce35fb40c3dab00791a3d6c485022341354c44 # v0.0.6
        with:
          executable-name: gilt
          changes-file: 
          target: ${{ matrix.platform.target }}
          archive-name: ${{ matrix.platform.archive-name }}
      
      - if: ${{ ! startsWith(matrix.platform.runs-on, 'windows-') }}
        name: Publish Attestation (non-Windows)
        uses: actions/attest-build-provenance@db473fddc028af60658334401dc6fa3ffd8669fd # v2.3.0
        with:
          subject-path: ./${{ matrix.platform.target }}.tar.gz, ./target/${{ matrix.platform.target }}/release/gilt
      
      - if: ${{ startsWith(matrix.platform.runs-on, 'windows-') }}
        name: Publish Attestation (Windows)
        uses: actions/attest-build-provenance@db473fddc028af60658334401dc6fa3ffd8669fd # v2.3.0
        with:
          subject-path: .\\${{ matrix.platform.target }}.zip, .\\target\${{ matrix.platform.target }}\release\gilt.exe
